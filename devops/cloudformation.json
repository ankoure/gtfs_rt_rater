{
  "Resources": {
    "GtfsRtBucketPolicy": {
      "Type": "AWS::IAM::ManagedPolicy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": ["s3:GetObject", "s3:PutObject"],
              "Resource": [
                "arn:aws:s3:::gtfs-rt-feeds",
                "arn:aws:s3:::gtfs-rt-feeds/*"
              ]
            },
            {
              "Effect": "Allow",
              "Action": "s3:ListBucket",
              "Resource": [
                "arn:aws:s3:::gtfs-rt-feeds",
                "arn:aws:s3:::gtfs-rt-feeds/*"
              ]
            }
          ]
        },
        "Roles": [
          {
            "Ref" : "S3BucketsRole"
          }
        ]
      }
    },
    "S3BucketsRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "AssumeRolePolicyDocument": {
          "Version" : "2012-10-17",
          "Statement" : [
            {
              "Effect" : "Allow",
              "Principal" : {
                "Service" : ["ec2.amazonaws.com"]
              },
              "Action" : [
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Path" : "/",
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
        ]
      }
    },
    "S3BucketsInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "S3BucketsRole"
          }
        ]
      }
    },
    "GtfsRtInstance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Fn::Sub": "{{resolve:ssm:/aws/service/canonical/ubuntu/server/22.04/stable/current/arm64/hvm/ebs-gp2/ami-id}}"
        },
        "InstanceType": "t4g.small",
        "KeyName": "gtfs-rt-rater",
        "IamInstanceProfile" : {
          "Ref" : "S3BucketsInstanceProfile"
        },
        "PropagateTagsToVolumeOnCreation": true,
        "SecurityGroupIds": [
          {
            "Ref": "GtfsRtSecurityGroup"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "gtfs-rt-rater"
          },
          {
            "Key": "service",
            "Value": "gtfs-rt-rater"
          }
        ],
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": 32,
              "VolumeType": "gp3"
            }
          }
        ]
      }
    },
    "GtfsRtSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": {
          "Fn::Sub": "gtfs-rt-rater-securitygroup"
        },
        "GroupDescription": "Security group for gtfs-rt-rater - no inbound SSH required (using SSM)",
        "SecurityGroupIngress": []
      }
    },
    "InstanceStatusCheckAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": "gtfs-rt-rater-instance-status-check-failed",
        "AlarmDescription": "Alert when EC2 instance status checks fail",
        "MetricName": "StatusCheckFailed",
        "Namespace": "AWS/EC2",
        "Statistic": "Maximum",
        "Period": 60,
        "EvaluationPeriods": 2,
        "Threshold": 1,
        "ComparisonOperator": "GreaterThanOrEqualToThreshold",
        "Dimensions": [
          {
            "Name": "InstanceId",
            "Value": {
              "Ref": "GtfsRtInstance"
            }
          }
        ],
        "TreatMissingData": "breaching"
      }
    },
    "HighCPUAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": "gtfs-rt-rater-high-cpu",
        "AlarmDescription": "Alert when CPU utilization is consistently high",
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/EC2",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 85,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "InstanceId",
            "Value": {
              "Ref": "GtfsRtInstance"
            }
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    "HighMemoryAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": "gtfs-rt-rater-high-memory",
        "AlarmDescription": "Alert when memory utilization is high",
        "MetricName": "mem_used_percent",
        "Namespace": "CWAgent",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 85,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "InstanceId",
            "Value": {
              "Ref": "GtfsRtInstance"
            }
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    "DiskSpaceAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": "gtfs-rt-rater-low-disk-space",
        "AlarmDescription": "Alert when disk space is running low",
        "MetricName": "disk_used_percent",
        "Namespace": "CWAgent",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 80,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "InstanceId",
            "Value": {
              "Ref": "GtfsRtInstance"
            }
          },
          {
            "Name": "path",
            "Value": "/"
          },
          {
            "Name": "fstype",
            "Value": "ext4"
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    }
  },
  "Outputs": {
    "InstanceHostname": {
      "Description": "GTFS RT Rater's public hostname",
      "Value": {
        "Fn::GetAtt": [
          "GtfsRtInstance",
          "PublicDnsName"
        ]
      }
    }
  }
}