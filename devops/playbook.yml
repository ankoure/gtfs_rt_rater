---
- name: deploy gtfs-rt-rater on EC2
  hosts: all
  vars:
    ansible_connection: aws_ssm
    ansible_aws_ssm_bucket_name: gtfs-rt-ssm-logs
    ansible_aws_ssm_region: us-east-1
    ansible_remote_tmp: /tmp/.ansible/tmp
    datadog_api_key: "{{ lookup('env', 'DD_API_KEY') }}"
    datadog_site: "datadoghq.com"
    git_sha: "{{ lookup('env', 'GIT_SHA') }}"
    datadog_config:
      tags:
        - "git.repository_url:github.com/ankoure/gtfs_rt_rater"
        - "git.commit.sha:{{ lookup('env', 'GIT_SHA') }}"
        - "version:{{ lookup('env', 'GIT_SHA') }}"
      apm_config:
        enabled: true
      process_config:
        enabled: "true" # type: string
      logs_enabled: true
    network_config:
      enabled: true
    system_probe_config:
      enable_oom_kill: true
    datadog_checks:
      systemd:
        init_config:
        instances:
          - unit_names:
              - gtfs-rt-rater.service
  tasks:
    - name: Ensure app directory exists
      become: yes
      file:
        path: /home/ubuntu/gtfs_rt_rater
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"
    - name: get latest github repo
      become: yes
      become_user: ubuntu
      git:
        repo: https://github.com/ankoure/gtfs_rt_rater.git
        dest: /home/ubuntu/gtfs_rt_rater
        version: master
        force: yes

    - name: Install the Datadog Agent
      become: yes
      become_user: root
      import_role:
        name: datadog.dd.agent

    - name: copy env file
      become: yes
      become_user: ubuntu
      copy:
        src: .env
        dest: /home/ubuntu/gtfs_rt_rater/.env
        mode: "0644"

    - name: copy systemd service file
      become: yes
      become_user: root
      template:
        src: systemd.conf
        dest: /etc/systemd/system/gtfs-rt-rater.service
      register: systemd_copy

    - name: copy pre-built binary
      become: yes
      copy:
        src: artifacts/gtfs_rt_rater
        dest: /home/ubuntu/gtfs_rt_rater/gtfs_rt_rater
        owner: ubuntu
        group: ubuntu
        mode: "0755"
      register: binary_copy

    - name: Reload systemd daemon if service file changed
      become: yes
      become_user: root
      ansible.builtin.systemd:
        daemon_reload: true
      when: systemd_copy.changed

    - name: Make sure a service unit is running and enabled
      become: yes
      become_user: root
      ansible.builtin.systemd_service:
        state: started
        name: gtfs-rt-rater
        enabled: true

    - name: Restart service only if binary or systemd config changed
      become: yes
      become_user: root
      ansible.builtin.systemd_service:
        state: restarted
        name: gtfs-rt-rater
      when: binary_copy.changed or systemd_copy.changed
      register: service_restarted

    - name: Wait for service to be active
      become: yes
      become_user: root
      ansible.builtin.systemd_service:
        name: gtfs-rt-rater
      register: service_status
      until: service_status.status.ActiveState == "active"
      retries: 10
      delay: 3
      when: service_restarted.changed

    - name: Verify service is running (not failed)
      become: yes
      become_user: root
      ansible.builtin.systemd_service:
        name: gtfs-rt-rater
      register: service_check
      failed_when: service_check.status.ActiveState != "active"
      when: service_restarted.changed

    - name: Check service has been running for at least 10 seconds
      pause:
        seconds: 10
      when: service_restarted.changed

    - name: Final health check - ensure service didn't crash
      become: yes
      become_user: root
      ansible.builtin.systemd_service:
        name: gtfs-rt-rater
      register: final_check
      failed_when: final_check.status.ActiveState != "active"
      when: service_restarted.changed

    - name: Display service status
      become: yes
      become_user: root
      ansible.builtin.systemd_service:
        name: gtfs-rt-rater
      register: current_status

    - name: Show deployment result
      debug:
        msg: >-
          {{
            'Service restarted and healthy - Running since ' + current_status.status.ActiveEnterTimestamp
            if (service_restarted is defined and service_restarted.changed)
            else
            'No changes detected - Service already running since ' + current_status.status.ActiveEnterTimestamp
          }}
